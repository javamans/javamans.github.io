---
title: 14.Spring循环依赖
tags: spring
---

### Spring循环依赖

循环依赖只会出现在单例无参构造函数实例化情况下，有参构造函数的加`@Autowired`的循环依赖是直接报错的，多例的循环依赖也是直接报错的。

#### Spring循环依赖流程图

![循环依赖流程图](/img/spring/spring中单例实例的循环依赖.jpg)

- A类无参构造函数实例化后，设置三级缓存
- A类`populateBean`进行依赖注入，这里触发了B类属性的`getBean`操作
- B类无参构造函数实例化后，设置三级缓存
- B类`populateBean`进行依赖注入，这里触发了A类属性的`getBean`操作
- A类之前正在实例化，`singletonsCurrentlyInCreation`集合中已经有A类了，三级缓存里面也有了，所以这时候是从三级缓存中获取到的提前暴露的A实例，该实例还没有进行B类属性的依赖注入的，B类属性为空
- B类获取到了A类提前暴露实例注入到A类属性中了
- B类实例化已经完成，B类的实例化是由A类实例化中B属性的依赖注入触发的`getBean`操作进行的，现在B已经实例化，所以A类中B属性就可以完成依赖注入了，这时候A类B属性已经有值了
- B类A属性指向的就是A类实例堆空间，所以这时候B类A属性也会有值了