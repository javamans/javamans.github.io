---
title: 16.Spring源码中AOP入口
tags: spring
---

### AOP入口

通过扫描注解`@EnableAspectJAutoProxy(proxyTargetClass=true,exposeProxy=true)`注册了AOP入口类，具体看注解中的`@Import(AspectJAutoProxyRegistrar.class)`

```java
class AspectJAutoProxyRegistrar implements ImportBeanDefinitionRegistrar {

    @Override
    public void registerBeanDefinitions(
        AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry) {

        // 注册注解AOP入口类
        AopConfigUtils.registerAspectJAnnotationAutoProxyCreatorIfNecessary(registry);

        /**
		 * proxyTargetClass
		 * true
		 * 1、目标对象实现了接口--使用CGLIB代理机制
		 * 2、目标对象没有接口（只有实现类）--使用CGLIB代理机制
		 *
		 * false
		 * 1、目标对象实现了接口--使用JDK动态代理机制（代理实现了所有的接口）
		 * 2、目标对象没有接口（只有实现类）--使用CGLIB代理机制
		 */
        AnnotationAttributes enableAspectJAutoProxy =
            AnnotationConfigUtils.attributesFor(importingClassMetadata, EnableAspectJAutoProxy.class);
        if (enableAspectJAutoProxy != null) {
            if (enableAspectJAutoProxy.getBoolean("proxyTargetClass")) {
                AopConfigUtils.forceAutoProxyCreatorToUseClassProxying(registry);
            }
            // 是否需要把代理对象暴露出来，就是是否需要把代理对象用ThreadLocal存起来，如果是true则需要
            if (enableAspectJAutoProxy.getBoolean("exposeProxy")) {
                AopConfigUtils.forceAutoProxyCreatorToExposeProxy(registry);
            }
        }
    }

}
```

#### AopConfigUtils.registerOrEscalateApcAsRequired(AnnotationAwareAspectJAutoProxyCreator.class, registry, source)方法

```java
private static BeanDefinition registerOrEscalateApcAsRequired(
    Class<?> cls, BeanDefinitionRegistry registry, @Nullable Object source) {
    
    // 把AOP入口类封装成beanDefinition对象，要实例化
    RootBeanDefinition beanDefinition = new RootBeanDefinition(cls);
    beanDefinition.setSource(source);
    beanDefinition.getPropertyValues().add("order", Ordered.HIGHEST_PRECEDENCE);
    beanDefinition.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);
    // 注解aop入口类的beanName：internalAutoProxyCreator
    // 将该beanName注册，将beanName信息和beanDefinition保存到beanDefinitionMap和beanDefinitionNames中
    registry.registerBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME, beanDefinition);
    return beanDefinition;
}
```















